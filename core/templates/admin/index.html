{% extends "admin/base.html" %}
{% set title = "الرئيسية" %}
{% block content %}
  <div class="row g-3">
    <div class="col-12 col-md-4">
      <div class="card border-info">
        <div class="card-body">
          <div class="h5">شاراتي (Paper)</div>
          <div class="display-6">{{ paper_count }}</div>
          <div class="small-muted">آخر {{ lookback_days }} أيام</div>
          <a class="btn btn-outline-info mt-3" href="{{ url_for('admin.paper') }}">فتح</a>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-success">
        <div class="card-body">
          <div class="h5">Signals للتعلّم</div>
          <div class="display-6">{{ signals_count }}</div>
          <div class="small-muted">آخر {{ lookback_days }} أيام (من آخر 200)</div>
          <a class="btn btn-outline-success mt-3" href="{{ url_for('admin.signals') }}">فتح</a>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-warning">
        <div class="card-body">
          <div class="h5">صيانة</div>
          <div class="small-muted mb-2">تنظيف تلقائي موجود، وهذا زر تنظيف يدوي إذا احتجت</div>
          <form method="post" action="{{ url_for('admin.cleanup') }}" class="d-flex gap-2">
            <input class="form-control" name="days" type="number" min="1" max="365" value="{{ lookback_days }}">
            <button class="btn btn-warning" type="submit">تنظيف</button>
          </form>
        </div>
      </div>
    </div>
  </div>


  <div class="row g-3 mt-2">
    <div class="col-12 col-md-4">
      <div class="card border-primary">
        <div class="card-body">
          <div class="h5">مفتوحة</div>
          <div class="display-6">{{ open_paper_count }}</div>
          <div class="small-muted">Paper trades قيد المتابعة</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-danger">
        <div class="card-body">
          <div class="h5">مستحقة الآن</div>
          <div class="display-6">{{ due_now_count }}</div>
          <div class="small-muted">اضغط تحديث داخل البوت أو انتظر الجدولة</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-secondary">
        <div class="card-body">
          <div class="h5">نتائج 24h</div>
          <div class="display-6">{{ winrate|round(1) }}%</div>
          <div class="small-muted">{{ finals_count }} لقطات ثابتة (آخر {{ lookback_days }} أيام)</div>
        </div>
      </div>
    </div>
  </div>


<div class="row g-3 mt-2">
  <div class="col-12 col-md-3">
    <div class="card border-dark">
      <div class="card-body">
        <div class="h6">Avg R</div>
        <div class="display-6">{{ avg_r|round(2) }}</div>
        <div class="small-muted">Expectancy (آخر {{ lookback_days }} أيام)</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card border-dark">
      <div class="card-body">
        <div class="h6">Profit Factor</div>
        <div class="display-6">
          {{ profit_factor_display }}
        </div>
        <div class="small-muted">مجموع الأرباح / مجموع الخسائر (R)</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card border-dark">
      <div class="card-body">
        <div class="h6">Max DD</div>
        <div class="display-6">{{ (max_dd*100)|round(1) }}%</div>
        <div class="small-muted">على منحنى رأس المال الافتراضي</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card border-dark">
      <div class="card-body">
        <div class="h6">Equity (Virtual)</div>
        <div class="display-6">{{ equity_last|round(2) }}</div>
        <div class="small-muted">Start {{ start_capital }} | Risk {{ risk_pct }}%</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-2">
  <div class="col-12 col-lg-8">
    <div class="card">
      <div class="card-header">منحنى رأس المال (افتراضي)</div>
      <div class="card-body">
        {% if equity_svg %}
          <div class="text-primary">{{ equity_svg|safe }}</div>
        {% else %}
          <div class="small-muted">لا توجد بيانات كافية.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card">
      <div class="card-header">نتائج الضربات</div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between"><span>TP1</span><span class="badge bg-success">{{ tp1_hits }}</span></li>
          <li class="list-group-item d-flex justify-content-between"><span>TP2</span><span class="badge bg-success">{{ tp2_hits }}</span></li>
          <li class="list-group-item d-flex justify-content-between"><span>TP3</span><span class="badge bg-success">{{ tp3_hits }}</span></li>
          <li class="list-group-item d-flex justify-content-between"><span>Trail</span><span class="badge bg-warning text-dark">{{ trail_hits }}</span></li>
          <li class="list-group-item d-flex justify-content-between"><span>SL</span><span class="badge bg-danger">{{ sl_hits }}</span></li>
        </ul>
        <hr/>
        <div class="small fw-bold mb-2">توزيع R</div>
        <ul class="list-group list-group-flush">
          {% for b, c in r_hist %}
            <li class="list-group-item d-flex justify-content-between"><span class="mono">{{ b }}</span><span class="badge bg-secondary">{{ c }}</span></li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

  <div class="row g-3 mt-2">
    <div class="col-12 col-lg-5">
      <div class="card">
        <div class="card-header">أكثر الأسهم ظهورًا (Signals)</div>
        <div class="card-body">
          {% if top_symbols %}
            <ul class="list-group list-group-flush">
              {% for sym, c in top_symbols %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span class="mono">{{ sym }}</span>
                  <span class="badge bg-secondary rounded-pill">{{ c }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="small-muted">لا توجد بيانات كافية.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="card">
        <div class="card-header">آخر شارات (Paper)</div>
        <div class="card-body table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>وقت</th>
                <th>السهم</th>
                <th>Mode</th>
                <th>Side</th>
                <th>Entry</th>
                <th>SL</th>
                <th>TP</th>
              </tr>
            </thead>
            <tbody>
              {% for r in recent_paper %}
                <tr>
                  <td class="small-muted">{{ r.signal_ts }}</td>
                  <td class="mono">{{ r.symbol }}</td>
                  <td>{{ r.mode }}</td>
                  <td>{{ r.side }}</td>
                  <td class="mono">{{ r.entry }}</td>
                  <td class="mono">{{ r.sl }}</td>
                  <td class="mono">{{ r.tp }}</td>
                </tr>
              {% endfor %}
              {% if not recent_paper %}
                <tr><td colspan="7" class="small-muted">ما فيه شارات حالياً.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
